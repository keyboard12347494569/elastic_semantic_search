sequenceDiagram
    %% Title
    title ðŸ”„ Smart-Elastic-Search: Full Workflow (Ingestion â†’ Query)

    %% Data Ingestion Pipeline
    participant CSV_File as ðŸ—‚ï¸ CSV File
    participant Pandas as ðŸ¼ Pandas
    participant BulkLoader as ðŸ› ï¸ Ingest Script
    participant ES as ðŸ“¦ Elasticsearch

    CSV_File->>Pandas: read_csv()
    Pandas->>Pandas: Clean, Normalize, Validate
    Pandas->>BulkLoader: yield bulk actions
    BulkLoader->>ES: Bulk insert via helpers.bulk()

    Note over CSV_File,ES: ðŸ” Repeatable data loading with\nstable `_id` generation for deduplication

    %% Separator
    Note over ES,ES: ðŸ’¡ Index is now ready with n-gram search\nand custom pipeline (split locations)

    %% Inference Pipeline
    participant User as ðŸ§‘ User
    participant FastAPI as âš¡ FastAPI Server
    participant LLM as ðŸ§  Azure OpenAI
    participant Validator as ðŸ” DSL Validator
    participant ES as ðŸ“¦ Elasticsearch
    participant Summarizer as ðŸ§¾ Summarizer

    User->>FastAPI: POST /search { query, size, summarize }
    FastAPI->>LLM: ðŸ” prompt(query) â†’ DSL
    LLM-->>FastAPI: JSON DSL
    FastAPI->>Validator: validate DSL
    Validator-->>FastAPI: âœ… OK / âŒ Error
    FastAPI->>ES: execute_search(dsl)
    ES-->>FastAPI: hits + aggs
    alt summarize == True
        FastAPI->>Summarizer: summarize(query, es_response)
        Summarizer-->>FastAPI: summary text
    end
    FastAPI-->>User: JSON response with hits, aggs, summary
